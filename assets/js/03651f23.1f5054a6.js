"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[1635],{8453(e,n,t){t.d(n,{R:()=>l,x:()=>o});var i=t(6540);const a={},r=i.createContext(a);function l(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),i.createElement(r.Provider,{value:n},e.children)}},9338(e,n,t){t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"file/2026-01-01-file upload","title":"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20","description":"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20","source":"@site/javadoc/file/2026-01-01-file upload.md","sourceDirName":"file","slug":"/file/java-file-upload-qi niu","permalink":"/docs/javadoc/file/java-file-upload-qi niu","draft":false,"unlisted":false,"editUrl":"https://github.com/LiangHChao/docs/edit/master/javadoc/file/2026-01-01-file upload.md","tags":[{"inline":true,"label":"java","permalink":"/docs/javadoc/tags/java"},{"inline":true,"label":"file","permalink":"/docs/javadoc/tags/file"}],"version":"current","frontMatter":{"slug":"java-file-upload-qi niu","title":"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20","authors":["lianghchao"],"tags":["java","file"]},"sidebar":"javaSidebar","previous":{"title":"\u6587\u4ef6\u670d\u52a1","permalink":"/docs/javadoc/category/\u6587\u4ef6\u670d\u52a1"},"next":{"title":"\u8fc7\u6ee4\u5668&\u62e6\u622a\u5668","permalink":"/docs/javadoc/category/\u8fc7\u6ee4\u5668\u62e6\u622a\u5668"}}');var a=t(4848),r=t(8453);const l={slug:"java-file-upload-qi niu",title:"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20",authors:["lianghchao"],tags:["java","file"]},o=void 0,u={},c=[{value:"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20",id:"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20",level:3},{value:"pom.xml",id:"pomxml",level:3},{value:"application.yml",id:"applicationyml",level:3},{value:"config",id:"config",level:3},{value:"service",id:"service",level:3},{value:"controller",id:"controller",level:3},{value:"\u5b8c\u6574\u4ee3\u7801",id:"\u5b8c\u6574\u4ee3\u7801",level:3}];function s(e){const n={code:"code",h3:"h3",pre:"pre",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h3,{id:"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20",children:"\u4e03\u725b\u4e91\u6587\u4ef6\u4e0a\u4f20"}),"\n",(0,a.jsx)(n.h3,{id:"pomxml",children:"pom.xml"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"\x3c!--web lombok qiniu--\x3e\n<dependency>\n    <groupId>com.qiniu</groupId>\n    <artifactId>qiniu-java-sdk</artifactId>\n    <version>[7.19.0, 7.19.99]</version>\n</dependency>\n"})}),"\n",(0,a.jsx)(n.h3,{id:"applicationyml",children:"application.yml"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yml",children:"server:\n  port: 8101\n\nqiniu:\n  accessKey: ak\n  secretKey: sk\n  bucket: bu\n  domainOfBucket: dob\n"})}),"\n",(0,a.jsx)(n.h3,{id:"config",children:"config"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'    // =============== \u914d\u7f6e\u7c7b ===============\n    @Data\n    @Component\n    @ConfigurationProperties(prefix = "qiniu")\n    public static class QiNiuConfig {\n        private String accessKey;\n        private String secretKey;\n        private String bucket;\n        private String domainOfBucket;\n    }\n'})}),"\n",(0,a.jsx)(n.h3,{id:"service",children:"service"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'    // =============== \u4e03\u725b\u670d\u52a1\u7ec4\u4ef6 ===============\n    @Slf4j\n    @Component\n    public static class QiNiuService {\n        private final UploadManager uploadManager;\n        private final BucketManager bucketManager;\n        private final Auth auth;\n        private final QiNiuConfig config;\n\n        public QiNiuService(QiNiuConfig config) {\n            this.config = config;\n            this.auth = Auth.create(config.getAccessKey(), config.getSecretKey());\n\n            Configuration cfg = Configuration.create(Region.autoRegion());\n            cfg.resumableUploadAPIVersion = Configuration.ResumableUploadAPIVersion.V2;\n            this.uploadManager = new UploadManager(cfg);\n            bucketManager = new BucketManager(auth, cfg);\n        }\n\n        public String upload(MultipartFile file) throws IOException {\n            if (file == null || file.isEmpty()) {\n                throw new IllegalArgumentException("\u4e0a\u4f20\u6587\u4ef6\u4e3a\u7a7a");\n            }\n            return uploadStream(file.getInputStream(), file.getOriginalFilename());\n        }\n\n        public String uploadBytes(byte[] bytes, String filename){\n            if (bytes == null || bytes.length == 0) {\n                throw new IllegalArgumentException("\u6587\u4ef6\u5185\u5bb9\u4e3a\u7a7a");\n            }\n\n            String upToken = uploadToken();\n            String key = generateUniqueKey(filename);\n\n            try {\n                Response response = uploadManager.put(bytes, key, upToken);\n                DefaultPutRet putRet = response.jsonToObject(DefaultPutRet.class);\n                log.info("\u6587\u4ef6\u4e0a\u4f20\u6210\u529f: key={}, hash={}", putRet.key, putRet.hash);\n                return config.getDomainOfBucket() + "/" + putRet.key;\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u4e0a\u4f20\u5931\u8d25 (bytes)", ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u4e0a\u4f20\u5230\u4e03\u725b\u5931\u8d25", ex);\n            }\n        }\n\n        public void delete(String fileName) {\n            try {\n                bucketManager.delete(config.getBucket(), fileName);\n                log.info("\u6587\u4ef6\u5220\u9664\u6210\u529f: key={}", fileName);\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u5220\u9664\u5931\u8d25: key={}", fileName, ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u5220\u9664\u4e03\u725b\u6587\u4ef6\u5931\u8d25", ex);\n            }\n        }\n\n        public void deleteBatch(String... fileNameList) {\n            if (fileNameList == null || fileNameList.length == 0) {\n                return;\n            }\n            if (fileNameList.length > 1000) {\n                throw new IllegalArgumentException("\u6279\u91cf\u5220\u9664\u6570\u91cf\u4e0d\u80fd\u8d85\u8fc71000");\n            }\n\n            try {\n                BucketManager.BatchOperations batchOperations = new BucketManager.BatchOperations();\n                batchOperations.addDeleteOp(config.getBucket(), fileNameList);\n                Response response = bucketManager.batch(batchOperations);\n                BatchStatus[] batchStatusList = response.jsonToObject(BatchStatus[].class);\n\n                for (int i = 0; i < fileNameList.length; i++) {\n                    BatchStatus status = batchStatusList[i];\n                    String key = fileNameList[i];\n                    if (status.code == 200) {\n                        log.info("\u6279\u91cf\u5220\u9664\u6210\u529f: key={}", key);\n                    } else {\n                        log.warn("\u6279\u91cf\u5220\u9664\u5931\u8d25: key={}, error={}", key, status.data.error);\n                    }\n                }\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u6279\u91cf\u5220\u9664\u5f02\u5e38", ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u6279\u91cf\u5220\u9664\u5931\u8d25", ex);\n            }\n        }\n\n        public String uploadStream(InputStream stream, String filename){\n            if (stream == null) {\n                throw new IllegalArgumentException("\u8f93\u5165\u6d41\u4e3a\u7a7a");\n            }\n            // \u6ce8\u610f\uff1astream.available() \u4e0d\u53ef\u9760\uff0c\u4e0d\u7528\u4e8e\u5224\u65ad\u662f\u5426\u4e3a\u7a7a\n\n            String upToken = uploadToken();\n            String key = generateUniqueKey(filename);\n\n            try {\n                Response response = uploadManager.put(stream, key, upToken, null, null);\n                DefaultPutRet putRet = response.jsonToObject(DefaultPutRet.class);\n                log.info("\u6d41\u5f0f\u4e0a\u4f20\u6210\u529f: key={}, hash={}", putRet.key, putRet.hash);\n                return config.getDomainOfBucket() + "/" + putRet.key;\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u6d41\u5f0f\u4e0a\u4f20\u5931\u8d25", ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u4e0a\u4f20\u5230\u4e03\u725b\u5931\u8d25", ex);\n            }\n        }\n\n        public String uploadToken() {\n            return auth.uploadToken(config.getBucket());\n        }\n        // === \u5de5\u5177\u65b9\u6cd5 ===\n        private String generateUniqueKey(String originalFilename) {\n            String ext = "";\n            if (originalFilename != null && originalFilename.contains(".")) {\n                ext = originalFilename.substring(originalFilename.lastIndexOf("."));\n            }\n            return UUID.randomUUID() + ext;\n        }\n\n        private void handleQiniuException(QiniuException ex) {\n            Response r = ex.response;\n            if (r != null) {\n                try {\n                    log.error("\u4e03\u725b\u9519\u8bef\u54cd\u5e94: code={}, body={}", r.statusCode, r.bodyString());\n                } catch (Exception e) {\n                    log.error("\u8bfb\u53d6\u4e03\u725b\u9519\u8bef\u54cd\u5e94\u4f53\u5931\u8d25", e);\n                }\n            }\n        }\n    }\n'})}),"\n",(0,a.jsx)(n.h3,{id:"controller",children:"controller"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'\n    // =============== Controller ===============\n    @RestController\n    @RequiredArgsConstructor\n    public static class UploadController {\n\n        private final QiNiuService qiNiuService;\n\n        @PostMapping("/upload")\n        public String uploadFile(@RequestParam("file") MultipartFile file) throws IOException {\n            return qiNiuService.upload(file);\n        }\n\n        @PostMapping("/upload-multi")\n        public List<String> uploadFiles(@RequestParam("files") List<MultipartFile> files) {\n            return files.stream()\n                    .map(file -> {\n                        try {\n                            return qiNiuService.upload(file);\n                        } catch (IOException e) {\n                            log.error("\u591a\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25: filename={}", file.getOriginalFilename(), e);\n                            throw new RuntimeException("\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25: " + file.getOriginalFilename(), e);\n                        }\n                    })\n                    .collect(Collectors.toList());\n        }\n\n        @PostMapping(value = "/upload-stream", consumes = MediaType.APPLICATION_OCTET_STREAM_VALUE)\n        public String uploadStream(HttpServletRequest request) throws IOException {\n            try (InputStream is = request.getInputStream()) {\n                byte[] bytes = is.readAllBytes();\n                String filename = "stream_" + System.currentTimeMillis() + ".bin";\n                return qiNiuService.uploadBytes(bytes, filename);\n            }\n        }\n\n        @PostMapping("/upload-with-meta")\n        public String uploadWithMeta(\n                @RequestParam("file") MultipartFile file,\n                @RequestParam("userId") String userId,\n                @RequestParam("category") String category) {\n            log.info("\u5e26\u5143\u6570\u636e\u4e0a\u4f20: userId={}, category={}, filename={}", userId, category, file.getOriginalFilename());\n            try {\n                return qiNiuService.upload(file);\n            } catch (IOException e) {\n                log.error("\u5e26\u5143\u6570\u636e\u4e0a\u4f20\u5931\u8d25", e);\n                throw new RuntimeException(e);\n            }\n        }\n\n\n        /**\n         * \u5927\u6587\u4ef6\u4e0a\u4f20\uff0c\u7ed9\u524d\u7aeftoken\n         */\n        @GetMapping("/uptoken")\n        public String getUpToken() {\n            return qiNiuService.uploadToken();\n        }\n        @GetMapping("/delete")\n        public void delete(@RequestParam("fileName") String fileName) {\n            qiNiuService.delete(fileName);\n        }\n        @GetMapping("/delete-batch")\n        public void deleteBatch(@RequestParam("key") String... fileNameList) {\n            qiNiuService.deleteBatch(fileNameList);\n        }\n    }\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u5b8c\u6574\u4ee3\u7801",children:"\u5b8c\u6574\u4ee3\u7801"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'@Slf4j\n@SpringBootApplication\npublic class QiniuApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(QiniuApplication.class, args);\n    }\n\n    // =============== \u914d\u7f6e\u7c7b ===============\n    @Data\n    @Component\n    @ConfigurationProperties(prefix = "qiniu")\n    public static class QiNiuConfig {\n        private String accessKey;\n        private String secretKey;\n        private String bucket;\n        private String domainOfBucket;\n    }\n\n    // =============== \u4e03\u725b\u670d\u52a1\u7ec4\u4ef6 ===============\n    @Slf4j\n    @Component\n    public static class QiNiuService {\n        private final UploadManager uploadManager;\n        private final BucketManager bucketManager;\n        private final Auth auth;\n        private final QiNiuConfig config;\n\n        public QiNiuService(QiNiuConfig config) {\n            this.config = config;\n            this.auth = Auth.create(config.getAccessKey(), config.getSecretKey());\n\n            Configuration cfg = Configuration.create(Region.autoRegion());\n            cfg.resumableUploadAPIVersion = Configuration.ResumableUploadAPIVersion.V2;\n            this.uploadManager = new UploadManager(cfg);\n            bucketManager = new BucketManager(auth, cfg);\n        }\n\n        public String upload(MultipartFile file) throws IOException {\n            if (file == null || file.isEmpty()) {\n                throw new IllegalArgumentException("\u4e0a\u4f20\u6587\u4ef6\u4e3a\u7a7a");\n            }\n            return uploadStream(file.getInputStream(), file.getOriginalFilename());\n        }\n\n        public String uploadBytes(byte[] bytes, String filename){\n            if (bytes == null || bytes.length == 0) {\n                throw new IllegalArgumentException("\u6587\u4ef6\u5185\u5bb9\u4e3a\u7a7a");\n            }\n\n            String upToken = uploadToken();\n            String key = generateUniqueKey(filename);\n\n            try {\n                Response response = uploadManager.put(bytes, key, upToken);\n                DefaultPutRet putRet = response.jsonToObject(DefaultPutRet.class);\n                log.info("\u6587\u4ef6\u4e0a\u4f20\u6210\u529f: key={}, hash={}", putRet.key, putRet.hash);\n                return config.getDomainOfBucket() + "/" + putRet.key;\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u4e0a\u4f20\u5931\u8d25 (bytes)", ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u4e0a\u4f20\u5230\u4e03\u725b\u5931\u8d25", ex);\n            }\n        }\n\n        public void delete(String fileName) {\n            try {\n                bucketManager.delete(config.getBucket(), fileName);\n                log.info("\u6587\u4ef6\u5220\u9664\u6210\u529f: key={}", fileName);\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u5220\u9664\u5931\u8d25: key={}", fileName, ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u5220\u9664\u4e03\u725b\u6587\u4ef6\u5931\u8d25", ex);\n            }\n        }\n\n        public void deleteBatch(String... fileNameList) {\n            if (fileNameList == null || fileNameList.length == 0) {\n                return;\n            }\n            if (fileNameList.length > 1000) {\n                throw new IllegalArgumentException("\u6279\u91cf\u5220\u9664\u6570\u91cf\u4e0d\u80fd\u8d85\u8fc71000");\n            }\n\n            try {\n                BucketManager.BatchOperations batchOperations = new BucketManager.BatchOperations();\n                batchOperations.addDeleteOp(config.getBucket(), fileNameList);\n                Response response = bucketManager.batch(batchOperations);\n                BatchStatus[] batchStatusList = response.jsonToObject(BatchStatus[].class);\n\n                for (int i = 0; i < fileNameList.length; i++) {\n                    BatchStatus status = batchStatusList[i];\n                    String key = fileNameList[i];\n                    if (status.code == 200) {\n                        log.info("\u6279\u91cf\u5220\u9664\u6210\u529f: key={}", key);\n                    } else {\n                        log.warn("\u6279\u91cf\u5220\u9664\u5931\u8d25: key={}, error={}", key, status.data.error);\n                    }\n                }\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u6279\u91cf\u5220\u9664\u5f02\u5e38", ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u6279\u91cf\u5220\u9664\u5931\u8d25", ex);\n            }\n        }\n\n        public String uploadStream(InputStream stream, String filename){\n            if (stream == null) {\n                throw new IllegalArgumentException("\u8f93\u5165\u6d41\u4e3a\u7a7a");\n            }\n            // \u6ce8\u610f\uff1astream.available() \u4e0d\u53ef\u9760\uff0c\u4e0d\u7528\u4e8e\u5224\u65ad\u662f\u5426\u4e3a\u7a7a\n\n            String upToken = uploadToken();\n            String key = generateUniqueKey(filename);\n\n            try {\n                Response response = uploadManager.put(stream, key, upToken, null, null);\n                DefaultPutRet putRet = response.jsonToObject(DefaultPutRet.class);\n                log.info("\u6d41\u5f0f\u4e0a\u4f20\u6210\u529f: key={}, hash={}", putRet.key, putRet.hash);\n                return config.getDomainOfBucket() + "/" + putRet.key;\n            } catch (QiniuException ex) {\n                log.error("\u4e03\u725b\u6d41\u5f0f\u4e0a\u4f20\u5931\u8d25", ex);\n                handleQiniuException(ex);\n                throw new RuntimeException("\u4e0a\u4f20\u5230\u4e03\u725b\u5931\u8d25", ex);\n            }\n        }\n\n        public String uploadToken() {\n            return auth.uploadToken(config.getBucket());\n        }\n\n        // === \u5de5\u5177\u65b9\u6cd5 ===\n        private String generateUniqueKey(String originalFilename) {\n            String ext = "";\n            if (originalFilename != null && originalFilename.contains(".")) {\n                ext = originalFilename.substring(originalFilename.lastIndexOf("."));\n            }\n            return UUID.randomUUID() + ext;\n        }\n\n        private void handleQiniuException(QiniuException ex) {\n            Response r = ex.response;\n            if (r != null) {\n                try {\n                    log.error("\u4e03\u725b\u9519\u8bef\u54cd\u5e94: code={}, body={}", r.statusCode, r.bodyString());\n                } catch (Exception e) {\n                    log.error("\u8bfb\u53d6\u4e03\u725b\u9519\u8bef\u54cd\u5e94\u4f53\u5931\u8d25", e);\n                }\n            }\n        }\n    }\n\n    // =============== Controller ===============\n    @RestController\n    @RequiredArgsConstructor\n    public static class UploadController {\n\n        private final QiNiuService qiNiuService;\n\n        @PostMapping("/upload")\n        public String uploadFile(@RequestParam("file") MultipartFile file) throws IOException {\n            return qiNiuService.upload(file);\n        }\n\n        @PostMapping("/upload-multi")\n        public List<String> uploadFiles(@RequestParam("files") List<MultipartFile> files) {\n            return files.stream()\n                    .map(file -> {\n                        try {\n                            return qiNiuService.upload(file);\n                        } catch (IOException e) {\n                            log.error("\u591a\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25: filename={}", file.getOriginalFilename(), e);\n                            throw new RuntimeException("\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25: " + file.getOriginalFilename(), e);\n                        }\n                    })\n                    .collect(Collectors.toList());\n        }\n\n        @PostMapping(value = "/upload-stream", consumes = MediaType.APPLICATION_OCTET_STREAM_VALUE)\n        public String uploadStream(HttpServletRequest request) throws IOException {\n            try (InputStream is = request.getInputStream()) {\n                byte[] bytes = is.readAllBytes();\n                String filename = "stream_" + System.currentTimeMillis() + ".bin";\n                return qiNiuService.uploadBytes(bytes, filename);\n            }\n        }\n\n        @PostMapping("/upload-with-meta")\n        public String uploadWithMeta(\n                @RequestParam("file") MultipartFile file,\n                @RequestParam("userId") String userId,\n                @RequestParam("category") String category) {\n            log.info("\u5e26\u5143\u6570\u636e\u4e0a\u4f20: userId={}, category={}, filename={}", userId, category, file.getOriginalFilename());\n            try {\n                return qiNiuService.upload(file);\n            } catch (IOException e) {\n                log.error("\u5e26\u5143\u6570\u636e\u4e0a\u4f20\u5931\u8d25", e);\n                throw new RuntimeException(e);\n            }\n        }\n\n\n        /**\n         * \u5927\u6587\u4ef6\u4e0a\u4f20\uff0c\u7ed9\u524d\u7aeftoken\n         */\n        @GetMapping("/uptoken")\n        public String getUpToken() {\n            return qiNiuService.uploadToken();\n        }\n        @GetMapping("/delete")\n        public void delete(@RequestParam("fileName") String fileName) {\n            qiNiuService.delete(fileName);\n        }\n        @GetMapping("/delete-batch")\n        public void deleteBatch(@RequestParam("key") String... fileNameList) {\n            qiNiuService.deleteBatch(fileNameList);\n        }\n    }\n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(s,{...e})}):s(e)}}}]);