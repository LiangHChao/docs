---
slug: java-async
title: Javaå¼‚æ­¥è§£è€¦
authors: [ lianghchao ]
tags: [ async ]
---
## Javaå¼‚æ­¥è§£è€¦ 
- ä»£ç å¯è¡Œæ€§å¾…éªŒè¯
- åœ¨ Spring Boot ä¸­æ–°å¼€ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç”Ÿæˆæ–‡ä»¶è¿™ç±»å¼‚æ­¥ã€è€—æ—¶æ“ä½œï¼Œæœ‰å¤šç§å®ç°æ–¹å¼ã€‚æ ¸å¿ƒç›®æ ‡æ˜¯ï¼šé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼ˆå¦‚ HTTP è¯·æ±‚çº¿ç¨‹ï¼‰ï¼Œæå‡ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚

### ä»¥ä¸‹æ˜¯ 5 ç§ä¸»æµå®ç°æ–¹å¼ï¼Œä»ç®€å•åˆ°é«˜çº§ï¼Œé™„ä»£ç ç¤ºä¾‹å’Œé€‚ç”¨åœºæ™¯ï¼š

### âœ… æ–¹å¼ 1ï¼šä½¿ç”¨ @Asyncï¼ˆæœ€æ¨èï¼Spring åŸç”Ÿæ”¯æŒï¼‰
æ­¥éª¤ï¼š
- å¯ç”¨å¼‚æ­¥æ”¯æŒï¼šåœ¨å¯åŠ¨ç±»æˆ–é…ç½®ç±»åŠ  @EnableAsync
- å®šä¹‰å¼‚æ­¥æ–¹æ³•ï¼šåœ¨ Service æ–¹æ³•ä¸ŠåŠ  @Async
- è°ƒç”¨ï¼šç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•å³å¯ï¼ˆè‡ªåŠ¨å¼‚æ­¥æ‰§è¡Œï¼‰
* ä»£ç ç¤ºä¾‹ï¼š
```java
// 1. å¯ç”¨å¼‚æ­¥
@SpringBootApplication
@EnableAsync // ğŸ‘ˆ å…³é”®æ³¨è§£
public class Application {
public static void main(String[] args) {
SpringApplication.run(Application.class, args);
}
}

// 2. å¼‚æ­¥ Service
@Service
public class FileService {

    @Async // ğŸ‘ˆ æ ‡è®°ä¸ºå¼‚æ­¥æ–¹æ³•
    public void generateFileAsync(String fileName) {
        System.out.println("å½“å‰çº¿ç¨‹: " + Thread.currentThread().getName());
        // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼ˆå¦‚ç”Ÿæˆ Excel/PDFï¼‰
        try {
            Thread.sleep(3000);
            Files.write(Paths.get("/tmp/" + fileName), "Hello Async File".getBytes());
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}

// 3. Controller è°ƒç”¨
@RestController
public class FileController {

    @Autowired
    private FileService fileService;

    @GetMapping("/generate")
    public String generateFile() {
        fileService.generateFileAsync("report.xlsx"); // ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…
        return "æ–‡ä»¶ç”Ÿæˆå·²æäº¤ï¼";
    }
}
```
âš™ï¸ è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ˆå¼ºçƒˆå»ºè®®ï¼ï¼‰
é»˜è®¤ä½¿ç”¨ SimpleAsyncTaskExecutorï¼ˆæ¯æ¬¡æ–°å»ºçº¿ç¨‹ï¼Œæ— å¤ç”¨ï¼‰ï¼Œåº”è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š

```java
@Configuration
@EnableAsync
public class AsyncConfig {

    @Bean("fileTaskExecutor")
    public Executor fileTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(2);
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(10);
        executor.setThreadNamePrefix("file-async-");
        executor.initialize();
        return executor;
    }
}

// åœ¨ Service ä¸­æŒ‡å®šçº¿ç¨‹æ± 
@Async("fileTaskExecutor") // ğŸ‘ˆ ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± 
public void generateFileAsync(String fileName) { }
```
âœ… ä¼˜ç‚¹ï¼šç®€æ´ã€Spring é›†æˆå¥½ã€æ”¯æŒå¼‚å¸¸å¤„ç†ã€å¯ç›‘æ§

âŒ ç¼ºç‚¹ï¼šä»…é™äº Spring Bean æ–¹æ³•

### âœ… æ–¹å¼ 2ï¼šä½¿ç”¨ CompletableFutureï¼ˆJava 8+ï¼Œçµæ´»å¼ºå¤§ï¼‰

é€‚åˆéœ€è¦é“¾å¼è°ƒç”¨ã€ç»„åˆå¤šä¸ªå¼‚æ­¥ä»»åŠ¡çš„åœºæ™¯ã€‚

```java
@Service
public class FileService {

    public void triggerGenerateFile(String fileName) {
        CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
            System.out.println("çº¿ç¨‹: " + Thread.currentThread().getName());
            try {
                Thread.sleep(3000);
                Files.write(Paths.get("/tmp/" + fileName), "Hello CompletableFuture".getBytes());
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        }, getCustomExecutor()); // å¯ä¼ è‡ªå®šä¹‰çº¿ç¨‹æ± 

        // å¯é€‰ï¼šå¤„ç†ç»“æœæˆ–å¼‚å¸¸
        future.thenRun(() -> System.out.println("æ–‡ä»¶ç”Ÿæˆå®Œæˆ"))
              .exceptionally(ex -> {
                  System.err.println("ç”Ÿæˆå¤±è´¥: " + ex.getMessage());
                  return null;
              });
    }

    private Executor getCustomExecutor() {
        return Executors.newFixedThreadPool(3, r -> new Thread(r, "file-completable-"));
    }
}
```
âœ… ä¼˜ç‚¹ï¼šéé˜»å¡ã€æ”¯æŒç»„åˆã€å‡½æ•°å¼ç¼–ç¨‹é£æ ¼

âŒ ç¼ºç‚¹ï¼šéœ€æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹æ± ï¼Œå¼‚å¸¸å¤„ç†ç¨å¤æ‚

### âœ… æ–¹å¼ 3ï¼šä½¿ç”¨ ExecutorServiceï¼ˆåº•å±‚æ§åˆ¶ï¼Œçµæ´»ï¼‰

ç›´æ¥ä½¿ç”¨ Java å¹¶å‘åŒ…ï¼Œé€‚åˆéœ€è¦ç²¾ç»†æ§åˆ¶çº¿ç¨‹çš„åœºæ™¯ã€‚

```java
@Service
public class FileService {

    private final ExecutorService executor = Executors.newFixedThreadPool(3, r -> 
        new Thread(r, "file-executor-"));

    public void generateFile(String fileName) {
        executor.submit(() -> {
            try {
                System.out.println("çº¿ç¨‹: " + Thread.currentThread().getName());
                Thread.sleep(3000);
                Files.write(Paths.get("/tmp/" + fileName), "Hello ExecutorService".getBytes());
            } catch (Exception e) {
                // è®°å½•æ—¥å¿—æˆ–å‘Šè­¦
                e.printStackTrace();
            }
        });
    }

    // åº”ç”¨å…³é—­æ—¶ä¼˜é›…å…³é—­çº¿ç¨‹æ± ï¼ˆé‡è¦ï¼ï¼‰
    @PreDestroy
    public void shutdown() {
        executor.shutdown();
    }
}
```
âœ… ä¼˜ç‚¹ï¼šå®Œå…¨æ§åˆ¶ã€æ€§èƒ½é«˜

âŒ ç¼ºç‚¹ï¼šéœ€æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€èµ„æºæ³„æ¼é£é™©

### âœ… æ–¹å¼ 4ï¼šä½¿ç”¨ ApplicationEvent + @EventListenerï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰

å°†â€œç”Ÿæˆæ–‡ä»¶â€æŠ½è±¡ä¸ºä¸€ä¸ªåº”ç”¨äº‹ä»¶ï¼Œç”±ç›‘å¬å™¨å¼‚æ­¥å¤„ç†ã€‚


```java
// 1. å®šä¹‰äº‹ä»¶
public class FileGenerateEvent extends ApplicationEvent {
private final String fileName;
public FileGenerateEvent(Object source, String fileName) {
super(source);
this.fileName = fileName;
}
public String getFileName() { return fileName; }
}

// 2. å‘å¸ƒäº‹ä»¶
@Service
public class OrderService {
@Autowired
private ApplicationEventPublisher eventPublisher;

    public void createOrder() {
        // ... ä¸šåŠ¡é€»è¾‘
        eventPublisher.publishEvent(new FileGenerateEvent(this, "order_report.pdf"));
    }
}

// 3. å¼‚æ­¥ç›‘å¬ï¼ˆå…³é”®ï¼š@Asyncï¼‰
@Component
public class FileGenerateListener {

    @Async // ğŸ‘ˆ å¿…é¡»åŠ  @Async æ‰å¼‚æ­¥
    @EventListener
    public void handleFileGenerate(FileGenerateEvent event) {
        System.out.println("å¼‚æ­¥ç”Ÿæˆæ–‡ä»¶: " + event.getFileName());
        // ç”Ÿæˆæ–‡ä»¶é€»è¾‘
    }
}
```
âœ… ä¼˜ç‚¹ï¼šé«˜åº¦è§£è€¦ã€ç¬¦åˆäº‹ä»¶é©±åŠ¨æ¶æ„

âŒ ç¼ºç‚¹ï¼šéœ€é…åˆ @Asyncï¼Œå¦åˆ™ä»æ˜¯åŒæ­¥

### âœ… æ–¹å¼ 5ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰â€”â€” åˆ†å¸ƒå¼åœºæ™¯

å¦‚æœç”Ÿæˆæ–‡ä»¶éå¸¸è€—æ—¶ï¼ˆå¦‚ > 10 åˆ†é’Ÿï¼‰ï¼Œæˆ–éœ€è·¨æœåŠ¡ï¼Œå»ºè®®ç”¨ RocketMQ / RabbitMQï¼š

```java
// å‘é€æ¶ˆæ¯
rocketMQTemplate.convertAndSend("FILE_GENERATE_TOPIC", "report.xlsx");

// æ¶ˆè´¹è€…ï¼ˆç‹¬ç«‹æœåŠ¡ï¼‰
@RocketMQMessageListener(topic = "FILE_GENERATE_TOPIC", group = "file-group")
public class FileGenerateConsumer implements RocketMQListener<String> {
@Override
public void onMessage(String fileName) {
// æ‰§è¡Œç”Ÿæˆæ–‡ä»¶é€»è¾‘ï¼ˆå¯éƒ¨ç½²åœ¨ä¸“ç”¨æœåŠ¡å™¨ï¼‰
}
}
```
âœ… ä¼˜ç‚¹ï¼šå‰Šå³°ã€é«˜å¯é ã€å¯æ‰©å±•

âŒ ç¼ºç‚¹ï¼šæ¶æ„å¤æ‚ï¼Œéœ€è¿ç»´ MQ

ğŸ“Š äº”ç§æ–¹å¼å¯¹æ¯”

|            æ–¹å¼             |    	é€‚ç”¨åœºæ™¯    |   	æ˜¯å¦éœ€é¢å¤–ä¾èµ–    |        	å¼‚å¸¸å¤„ç†         |    	æ¨èåº¦    |
|:-------------------------:|:-----------:|:-------------:|:--------------------:|:----------:|
|          @Async	          |  å•ä½“åº”ç”¨å¼‚æ­¥ä»»åŠ¡   | 	âŒï¼ˆSpring å†…ç½®ï¼‰ | 	âœ…ï¼ˆtry-catch / å…¨å±€å¼‚å¸¸ï¼‰ |   	â­â­â­â­â­   |
|     CompletableFuture     | 	é“¾å¼å¼‚æ­¥ã€ç»„åˆä»»åŠ¡	 |  âŒï¼ˆJava 8+ï¼‰	  | âœ…ï¼ˆ.exceptionally()ï¼‰  |   	â­â­â­â­    |
|      ExecutorService      |  	éœ€ç²¾ç»†æ§åˆ¶çº¿ç¨‹	  | âŒï¼ˆJava å¹¶å‘åŒ…ï¼‰	  |      âš ï¸ï¼ˆéœ€æ‰‹åŠ¨å¤„ç†ï¼‰       |    	â­â­â­    |
| ApplicationEvent + @Async |  	äº‹ä»¶é©±åŠ¨è§£è€¦	   |  âŒï¼ˆSpringï¼‰	   |          âœ…	          |    â­â­â­â­    |
|   MQï¼ˆRocketMQ/RabbitMQï¼‰   | 	åˆ†å¸ƒå¼ã€è¶…è€—æ—¶ä»»åŠ¡  |  	âœ…ï¼ˆéœ€éƒ¨ç½² MQï¼‰	  |       âœ…ï¼ˆé‡è¯•/æ­»ä¿¡ï¼‰       | 	â­â­â­ï¼ˆç‰¹å®šåœºæ™¯ï¼‰ |
âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹
ä¸è¦ç”¨ new Thread().start()

â†’ æ— æ³•ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼Œæ˜“å¯¼è‡´ OOMã€‚
åŠ¡å¿…è‡ªå®šä¹‰çº¿ç¨‹æ± 

â†’ é¿å…ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æˆ–é»˜è®¤çº¿ç¨‹æ± ã€‚
å¤„ç†å¼‚å¸¸

â†’ å¼‚æ­¥ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¸ä¼šæŠ›åˆ°ä¸»çº¿ç¨‹ï¼Œå¿…é¡»æ˜¾å¼æ•è·å¹¶è®°å½•ã€‚
èµ„æºæ¸…ç†

â†’ å¦‚æœç”Ÿæˆå¤§æ–‡ä»¶ï¼Œæ³¨æ„å†…å­˜å’Œç£ç›˜ç©ºé—´ã€‚
äº‹åŠ¡é—®é¢˜

â†’ @Async æ–¹æ³•é»˜è®¤ä¸å‚ä¸ Spring äº‹åŠ¡ï¼å¦‚éœ€äº‹åŠ¡ï¼Œéœ€ç‰¹æ®Šå¤„ç†ï¼ˆå¦‚å…ˆä¿å­˜ä»»åŠ¡çŠ¶æ€å†å¼‚æ­¥æ‰§è¡Œï¼‰ã€‚
âœ… æ€»ç»“ï¼šå¦‚ä½•é€‰æ‹©ï¼Ÿ
% åœºæ™¯ â†’ ç”¨ @Async + è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ˆç®€å•ã€å®‰å…¨ã€Spring åŸç”Ÿï¼‰
éœ€è¦ç»„åˆå¤šä¸ªå¼‚æ­¥æ“ä½œ â†’ ç”¨ CompletableFuture
è¿½æ±‚æè‡´è§£è€¦ â†’ ç”¨ ApplicationEvent + @Async
åˆ†å¸ƒå¼ç³»ç»Ÿ or è¶…é•¿è€—æ—¶ä»»åŠ¡ â†’ ç”¨ MQ
ğŸ’¡ è®°ä½ï¼š

â€œå¼‚æ­¥ä¸æ˜¯ç›®çš„ï¼Œè§£è€¦å’Œæå‡å“åº”é€Ÿåº¦æ‰æ˜¯ã€‚â€

é€‰æ‹©æœ€é€‚åˆä½ ç³»ç»Ÿæ¶æ„çš„æ–¹å¼å³å¯ã€‚