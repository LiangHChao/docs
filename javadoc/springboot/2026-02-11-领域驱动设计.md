---
slug: springboot-ddd
title: 领域驱动设计
authors: [ lianghchao ]
tags: [ java, spring boot ]
---

# 领域驱动设计架构详解

## 项目概述

这是一个基于**领域驱动设计（Domain-Driven Design, DDD）**理念构建的完整商品管理系统示例。项目采用Spring Boot 3.0.2 + Java 17技术栈，严格遵循DDD的分层架构和核心设计原则。

## 架构设计

### 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    接口适配层 (Interfaces)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ REST API    │  │ DTO         │  │ InterfaceAssembler  │  │
│  │ Controller  │  │             │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    应用层 (Application)                      │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              ProductApplicationService                  ││
│  │  - 用例编排  - 事务管理  - 流程控制                       ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│                    领域层 (Domain)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Product     │  │ ValueObjects│  │ ProductRepository   │  │
│  │ (聚合根)    │  │ (值对象)    │  │ (仓储接口)            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              ProductDomainService                       │ │
│  │  - 跨聚合业务逻辑  - 复杂业务规则                         │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                   基础设施层 (Infrastructure)                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ Repository  │  │ DataMapper  │  │ Assembler           │ │
│  │ Implementation│  │ (DO)      │  │ (数据转换)           │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件详解

### 1. 领域层 (Domain Layer)

#### 聚合根 - Product
```java
public class Product {
    // 聚合根标识
    private ProductId id;
    
    // 核心业务属性
    private ProductName name;           // 商品名称
    private CategoryId categoryId;      // 分类ID
    private Price price;               // 价格
    private Stock stock;               // 库存
    
    // 状态管理
    private PublishStatus publishStatus;    // 发布状态
    private NewStatus newStatus;           // 新品状态
    private RecommendStatus recommendStatus; // 推荐状态
    
    // 业务行为
    public void publish();              // 发布商品
    public void unpublish();            // 下架商品
    public void markAsNew();            // 设置为新品
    public boolean canBePublished();    // 验证发布条件
}
```

#### 值对象 (Value Objects)
值对象封装了业务概念，具有不可变性和值相等性：

- `ProductId` - 商品唯一标识
- `ProductName` - 商品名称（带验证规则）
- `Price` - 价格（带业务约束）
- `Stock` - 库存（带库存管理逻辑）
- `CategoryId` - 分类标识
- 各种状态枚举值对象

#### 仓储接口
```java
public interface ProductRepository {
    void save(Product product);
    Optional<Product> findById(ProductId productId);
    List<Product> findByCategoryId(CategoryId categoryId);
    List<Product> findByPublishStatus(PublishStatus publishStatus);
    // ... 更多业务导向的查询方法
}
```

#### 领域服务
```java
@Service
public class ProductDomainService {
    public Product createProduct(ProductName name, CategoryId categoryId, Price price);
    public void publishProduct(Product product);
    public void updatePrice(Product product, Price newPrice);
    // ... 跨聚合的复杂业务逻辑
}
```

### 2. 应用层 (Application Layer)

应用服务负责协调领域对象和基础设施：

```java
@Service
@Transactional
public class ProductApplicationService {
    public ProductId createProduct(String name, Long categoryId, String price);
    public void publishProduct(String productId);
    public List<Product> findPublishedProducts();
    public ProductStatistics getProductStatistics();
    // ... 用例场景的编排
}
```

### 3. 基础设施层 (Infrastructure Layer)

#### 仓储实现
```java
@Repository
public class ProductRepositoryImpl implements ProductRepository {
    private final ProductMapper productMapper;
    
    @Override
    public void save(Product product) {
        ProductDO productDO = ProductAssembler.toDO(product);
        productMapper.insert(productDO);
    }
    
    @Override
    public Optional<Product> findById(ProductId productId) {
        ProductDO productDO = productMapper.selectById(productId.getValue());
        return Optional.ofNullable(ProductAssembler.toDomain(productDO));
    }
}
```

#### 数据映射与装配
```java
public class ProductAssembler {
    // 领域对象 ↔ 数据传输对象 转换
    public static ProductDO toDO(Product product);
    public static Product toDomain(ProductDO productDO);
}
```

### 4. 接口层 (Interface Layer)

#### REST控制器
```java
@RestController
@RequestMapping("/api/products")
public class ProductController {
    @PostMapping
    public ResponseEntity<String> createProduct(@RequestBody ProductCreateRequest request);
    
    @PostMapping("/{id}/publish")
    public ResponseEntity<String> publishProduct(@PathVariable("id") String productId);
    
    @GetMapping("/{id}")
    public ResponseEntity<ProductResponse> getProduct(@PathVariable("id") String productId);
}
```

## DDD核心概念体现

### 1. 聚合 (Aggregate)
- **Product聚合根**管理商品的完整业务生命周期
- 聚合边界内保证业务一致性
- 通过聚合根对外提供统一的业务接口

### 2. 值对象 (Value Object)
```java
@Getter
@EqualsAndHashCode
public class Price {
    private final BigDecimal value;
    
    private Price(BigDecimal value) {
        // 业务约束验证
        if (value == null || value.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("价格不能为负数");
        }
        this.value = value.setScale(2, BigDecimal.ROUND_HALF_UP);
    }
    
    // 业务行为
    public Price add(Price other);
    public Price multiply(int quantity);
}
```

### 3. 仓储模式 (Repository Pattern)
- 仓储接口定义在领域层，实现放在基础设施层
- 面向业务的查询方法，而非技术导向的CRUD
- 隐藏数据访问的技术细节

### 4. 领域服务 (Domain Service)
处理跨聚合的业务逻辑：
```java
public void createProduct(ProductName name, CategoryId categoryId, Price price) {
    // 业务规则验证
    validateProductCreation(name, categoryId, price);
    
    // 创建聚合根
    Product product = new Product(name, categoryId, price);
    
    // 持久化
    productRepository.save(product);
}
```

## 业务流程示例

### 商品发布流程
```
1. 接口层: ProductController.publishProduct()
   ↓
2. 应用层: ProductApplicationService.publishProduct()
   ↓
3. 领域层: ProductDomainService.publishProduct()
   ↓
4. 聚合根: Product.publish() (执行业务规则验证)
   ↓
5. 仓储层: ProductRepository.save() (持久化状态变更)
```

### 商品创建流程
```
1. 接口层接收创建请求
2. 应用服务协调创建过程
3. 领域服务验证业务规则
4. 创建Product聚合根实例
5. 通过仓储保存到数据库
6. 返回聚合根标识
```

## 技术实现特点

### 1. 类型安全
- 使用值对象确保数据一致性
- 编译时就能发现类型错误
- 避免原始类型带来的语义模糊

### 2. 业务导向
- API设计面向业务场景而非技术实现
- 查询方法体现业务意图
- 异常信息具有业务含义

### 3. 分层解耦
- 严格遵循依赖倒置原则
- 上层不依赖下层具体实现
- 通过接口定义契约

### 4. 可测试性
- 领域逻辑独立于基础设施
- 可以进行纯单元测试
- 便于Mock和Stub

## 项目优势

### ✅ 符合DDD设计原则
- 清晰的聚合边界
- 丰富的值对象设计
- 完整的分层架构
- 面向业务的接口设计

### ✅ 良好的可维护性
- 业务逻辑集中管理
- 职责分离清晰
- 易于扩展和修改
- 降低系统复杂度

### ✅ 技术实现成熟
- Spring Boot 3.0.2稳定版本
- MyBatis Plus高效持久化
- Java 17现代语言特性
- 完善的异常处理机制

## 运行与测试

### 启动项目
```bash
mvn spring-boot:run
```

### API测试示例
```bash
# 创建商品
curl -X POST http://localhost:8003/api/products \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试商品",
    "categoryId": 1,
    "price": 99.99
  }'

# 发布商品
curl -X POST http://localhost:8003/api/products/{productId}/publish

# 查询商品
curl http://localhost:8003/api/products/{productId}
```

## 总结

本项目完整展现了DDD的核心思想：
> **将复杂的业务逻辑封装在领域层，通过清晰的分层架构实现业务与技术的分离**

这是一个优秀的DDD实践示例，适合学习和参考DDD设计模式在实际项目中的应用。